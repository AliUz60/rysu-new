<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkada≈ü Sohbet ¬∑ Base64 Resimli</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; }
        body { height: 100vh; display: flex; background-color: #1e2124; overflow: hidden; }
        .servers { width: 72px; background-color: #1a1c1f; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; overflow-y: auto; }
        .server-icon { width: 48px; height: 48px; border-radius: 30px; background: #2b2f33; display: flex; align-items: center; justify-content: center; color: #d1d5da; font-size: 20px; font-weight: bold; transition: 0.1s; cursor: pointer; position: relative; }
        .server-icon.active { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-icon:hover { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-divider { width: 32px; height: 2px; background-color: #2b2f33; margin: 4px 0; }
        .server-icon.dm { background: #2f3136; color: #3ba55d; }
        .server-icon.add-server { background: #2f3136; color: #3a6ea5; font-size: 24px; }

        .channels-panel { width: 240px; background-color: #2b2f33; display: flex; flex-direction: column; color: #b9bbbe; }
        .server-name { padding: 18px 16px; font-weight: 600; color: #ffffff; border-bottom: 1px solid #1e2124; display: flex; align-items: center; justify-content: space-between; cursor: pointer; position: relative; }
        .server-name i { transition: transform 0.2s; }
        .server-menu { position: absolute; top: 60px; left: 10px; background: #2f3338; border-radius: 4px; box-shadow: 0 0 10px black; display: none; z-index: 100; width: 160px; }
        .server-menu.active { display: block; }
        .server-menu ul { list-style: none; padding: 8px 0; }
        .server-menu li { padding: 8px 16px; color: #dcddde; cursor: pointer; }
        .server-menu li:hover { background-color: #3a6ea5; color: white; }
        .server-menu li.danger:hover { background-color: #f04747; }

        .channel-category { padding: 16px 16px 4px 16px; text-transform: uppercase; font-size: 12px; font-weight: 600; color: #8e9297; display: flex; align-items: center; justify-content: space-between; }
        .channel { padding: 6px 16px; margin: 1px 8px; border-radius: 6px; display: flex; align-items: center; gap: 8px; color: #b9bbbe; cursor: pointer; font-size: 15px; }
        .channel:hover { background-color: #35393f; color: #dcddde; }
        .channel.active { background-color: #3d434a; color: #ffffff; }
        .channel i { font-size: 20px; width: 22px; text-align: center; }
        .user-footer { padding: 16px; border-top: 1px solid #1e2124; display: flex; align-items: center; gap: 8px; margin-top: auto; }

        .chat-area { flex: 1; background-color: #31363b; display: flex; flex-direction: column; }
        .chat-header { padding: 12px 20px; background-color: #2f3338; border-bottom: 1px solid #1e2124; display: flex; align-items: center; gap: 10px; color: #ffffff; font-weight: 600; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .message { display: flex; gap: 16px; align-items: flex-start; }
        .message-avatar { width: 40px; height: 40px; border-radius: 20px; background-color: #3a6ea5; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-transform: uppercase; flex-shrink: 0; }
        .message-content { flex: 1; }
        .message-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
        .message-author { font-weight: 600; color: #ffffff; }
        .message-time { font-size: 11px; color: #8e9297; }
        .message-text { color: #d1d5da; word-wrap: break-word; background-color: #2f3338; padding: 8px 12px; border-radius: 18px; max-width: 70%; border-top-left-radius: 4px; }
        .own-message .message-text { background-color: #3a6ea5; color: white; border-top-left-radius: 18px; border-top-right-radius: 4px; margin-left: auto; }
        .own-message { flex-direction: row-reverse; }
        .own-message .message-header { justify-content: flex-end; }
        .message-image { max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer; }
        .message-input-area { padding: 20px; background-color: #2f3338; border-top: 1px solid #1e2124; }
        .input-wrapper { background-color: #40464b; border-radius: 8px; padding: 0 16px; display: flex; align-items: center; flex-wrap: wrap; }
        .input-wrapper input { flex: 1; background: transparent; border: none; padding: 12px 0; color: #dcddde; font-size: 15px; outline: none; min-width: 100px; }
        .input-wrapper input::placeholder { color: #7b7f85; }
        .input-wrapper i { color: #b9bbbe; font-size: 20px; margin-left: 12px; cursor: pointer; padding: 8px 0; }
        .input-wrapper i:hover { color: #dcddde; }

        .emoji-panel { position: absolute; bottom: 80px; right: 220px; background: #2f3338; border-radius: 8px; padding: 10px; display: none; grid-template-columns: repeat(6, 1fr); gap: 8px; z-index: 200; box-shadow: 0 0 10px black; }
        .emoji-panel.active { display: grid; }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; padding: 4px; border-radius: 4px; }
        .emoji-item:hover { background-color: #3a6ea5; }

        .users-panel { width: 240px; background-color: #2b2f33; padding: 16px 8px; color: #b9bbbe; overflow-y: auto; }
        .users-title { text-transform: uppercase; font-size: 12px; font-weight: 600; padding: 0 8px 8px 8px; border-bottom: 1px solid #1e2124; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .user-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; justify-content: space-between; }
        .user-item:hover { background-color: #35393f; }
        .user-info { display: flex; align-items: center; gap: 8px; flex:1; }
        .user-status { width: 10px; height: 10px; border-radius: 50%; background-color: #3ba55d; }
        .user-status.offline { background-color: #747f8d; }
        .user-name { font-size: 14px; font-weight: 500; color: #dcddde; }
        .delete-friend { color: #b9bbbe; visibility: hidden; }
        .user-item:hover .delete-friend { visibility: visible; }
        .delete-friend:hover { color: #f04747; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: #2f3338; border-radius: 8px; width: 400px; max-width: 90%; padding: 20px; color: white; box-shadow: 0 0 20px black; }
        .modal-content h2 { margin-bottom: 16px; color: #fff; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; background: #1e2124; border: 1px solid #3d434a; color: white; border-radius: 4px; margin-bottom: 16px; }
        .modal-content button { background: #3a6ea5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 8px; }
        .modal-content button.secondary { background: #3d434a; }
        .modal-content button:hover { filter: brightness(1.2); }

        #file-input { display: none; }
        .context-menu { position: absolute; background: #2f3338; border: 1px solid #1e2124; border-radius: 4px; display: none; z-index: 2000; }
        .context-menu ul { list-style: none; padding: 4px 0; }
        .context-menu li { padding: 8px 20px; color: #dcddde; cursor: pointer; }
        .context-menu li:hover { background-color: #3a6ea5; color: white; }
        .context-menu li.danger:hover { background-color: #f04747; }

        .admin-badge { background-color: gold; color: black; border-radius: 4px; padding: 2px 6px; font-size: 10px; margin-left: 4px; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <!-- SOL SUNUCU Lƒ∞STESƒ∞ -->
    <div class="servers" id="server-list"></div>

    <!-- KANALLAR PANELƒ∞ -->
    <div class="channels-panel">
        <div class="server-name" id="current-server-name">
            <span id="server-name-text">genel</span>
            <i class="fas fa-chevron-down" id="server-menu-toggle"></i>
            <div class="server-menu" id="server-menu">
                <ul>
                    <li id="server-settings-option">Sunucu Ayarlarƒ±</li>
                    <li class="danger" id="delete-server-option-menu">Sunucuyu Sil</li>
                </ul>
            </div>
        </div>
        <div id="channel-list"></div>
        <div class="user-footer" id="user-footer">
            <div style="width:32px;height:32px;border-radius:16px;background:#3a6ea5;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;" id="avatar-letter">K</div>
            <div style="flex:1;color:white;font-size:14px;font-weight:500;" id="current-username">Y√ºkleniyor...</div>
            <i class="fas fa-cog" id="settings-button" style="cursor:pointer;"></i>
        </div>
    </div>

    <!-- ANA SOHBET ALANI -->
    <div class="chat-area">
        <div class="chat-header" id="chat-header">
            <i class="fas fa-hashtag" id="channel-icon"></i>
            <span id="current-channel">genel</span>
        </div>
        <div class="messages-container" id="messages-container"></div>
        <div class="message-input-area">
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
                <i class="fas fa-paperclip" id="attach-button" onclick="document.getElementById('file-input').click()"></i>
                <i class="fas fa-smile" id="emoji-button"></i>
                <i class="fas fa-paper-plane" id="send-button"></i>
            </div>
            <div class="emoji-panel" id="emoji-panel">
                <span class="emoji-item">üòÄ</span>
                <span class="emoji-item">üòÇ</span>
                <span class="emoji-item">üòç</span>
                <span class="emoji-item">ü•∫</span>
                <span class="emoji-item">üòé</span>
                <span class="emoji-item">üî•</span>
                <span class="emoji-item">‚úÖ</span>
                <span class="emoji-item">üëç</span>
                <span class="emoji-item">üëé</span>
                <span class="emoji-item">‚ù§Ô∏è</span>
                <span class="emoji-item">üéâ</span>
                <span class="emoji-item">üò¢</span>
            </div>
        </div>
    </div>

    <!-- SAƒû ARKADA≈û Lƒ∞STESƒ∞ -->
    <div class="users-panel" id="friends-panel">
        <div class="users-title">
            Arkada≈ülar
            <i class="fas fa-user-plus" id="add-friend-btn" onclick="openFriendModal()" style="cursor:pointer;"></i>
        </div>
        <div id="friends-list"></div>
        <div class="users-title" style="margin-top:20px;">Direkt Mesajlar</div>
        <div id="dm-list"></div>
    </div>

    <!-- MODALLAR -->
    <div class="modal active" id="username-modal">
        <div class="modal-content">
            <h2>‚ú® Arkada≈ü Sohbet'e Ho≈ü Geldin</h2>
            <p>Kullanƒ±cƒ± adƒ±nƒ± gir, hemen ba≈üla!</p>
            <input type="text" id="modal-username" placeholder="Kullanƒ±cƒ± adƒ±" value="">
            <button id="modal-username-save">Ba≈üla</button>
            <button class="secondary" id="modal-username-cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="server-modal">
        <div class="modal-content">
            <h2>‚ûï Yeni Sunucu Olu≈ütur</h2>
            <input type="text" id="new-server-name" placeholder="Sunucu adƒ±">
            <button onclick="createServer()">Olu≈ütur</button>
            <button class="secondary" onclick="closeServerModal()">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="friend-modal">
        <div class="modal-content">
            <h2>üë§ Arkada≈ü Ekle</h2>
            <input type="text" id="friend-username" placeholder="Kullanƒ±cƒ± adƒ±">
            <button onclick="addFriend()">Ekle</button>
            <button class="secondary" onclick="closeFriendModal()">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Ayarlar</h2>
            <label>Kullanƒ±cƒ± Adƒ±</label>
            <input type="text" id="settings-username" placeholder="Yeni kullanƒ±cƒ± adƒ±">
            <label>Tema</label>
            <select id="settings-theme">
                <option value="dark">Koyu (varsayƒ±lan)</option>
                <option value="light">A√ßƒ±k</option>
            </select>
            <p><small>Ne yazƒ±k ki sesli arama yapƒ±lamaz.</small></p>
            <button id="save-settings">Kaydet</button>
            <button class="secondary" id="close-settings">Kapat</button>
        </div>
    </div>

    <!-- Gizli dosya inputu -->
    <input type="file" id="file-input" accept="image/*" onchange="uploadImage(this)">

    <!-- Saƒü tƒ±k men√ºs√º -->
    <div class="context-menu" id="server-context-menu">
        <ul>
            <li class="danger" id="delete-server-option">Sunucuyu Sil</li>
        </ul>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCXca2LRaHFx6iZX9vhfe6lXMS9UY5nO54",
            authDomain: "rysu-server.firebaseapp.com",
            databaseURL: "https://rysu-server-default-rtdb.firebaseio.com",
            projectId: "rysu-server",
            storageBucket: "rysu-server.firebasestorage.app",
            messagingSenderId: "253844771451",
            appId: "1:253844771451:web:bd370ae5a93eae66fcc8de",
            measurementId: "G-T632DDDX6L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global deƒüi≈ükenler
        let currentUser = localStorage.getItem('chat_username') || null;
        const ADMIN_USER = "AliUz60";
        let currentServer = 'genel';
        let currentChannel = 'genel';
        let currentDMFriend = null;
        let contextMenu = document.getElementById('server-context-menu');
        let selectedServerForDelete = null;
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let isUploading = false;

        // DOM elementleri
        const usernameModal = document.getElementById('username-modal');
        const modalUsernameInput = document.getElementById('modal-username');
        const modalUsernameSave = document.getElementById('modal-username-save');
        const modalUsernameCancel = document.getElementById('modal-username-cancel');
        const serverModal = document.getElementById('server-modal');
        const friendModal = document.getElementById('friend-modal');
        const settingsModal = document.getElementById('settings-modal');
        const messagesContainer = document.getElementById('messages-container');
        const channelListDiv = document.getElementById('channel-list');
        const currentChannelSpan = document.getElementById('current-channel');
        const serverNameSpan = document.getElementById('server-name-text');
        const currentUsernameSpan = document.getElementById('current-username');
        const avatarLetter = document.getElementById('avatar-letter');
        const chatHeaderIcon = document.getElementById('channel-icon');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileInput = document.getElementById('file-input');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPanel = document.getElementById('emoji-panel');
        const settingsButton = document.getElementById('settings-button');
        const saveSettings = document.getElementById('save-settings');
        const closeSettings = document.getElementById('close-settings');
        const settingsUsername = document.getElementById('settings-username');
        const settingsTheme = document.getElementById('settings-theme');
        const serverMenuToggle = document.getElementById('server-menu-toggle');
        const serverMenu = document.getElementById('server-menu');
        const attachButton = document.getElementById('attach-button');

        // Kullanƒ±cƒ± adƒ± kontrol√º (benzersizlik)
        async function isUsernameTaken(username) {
            const snap = await db.ref('users/' + username).once('value');
            return snap.exists();
        }

        // Giri≈ü modalƒ±
        if (currentUser) {
            usernameModal.classList.remove('active');
            initApp();
        } else {
            usernameModal.classList.add('active');
        }

        modalUsernameSave.addEventListener('click', async () => {
            const name = modalUsernameInput.value.trim();
            if (name) {
                const taken = await isUsernameTaken(name);
                if (taken) {
                    alert('Bu kullanƒ±cƒ± adƒ± zaten alƒ±nmƒ±≈ü. L√ºtfen ba≈üka bir ad se√ßin.');
                } else {
                    currentUser = name;
                    localStorage.setItem('chat_username', currentUser);
                    usernameModal.classList.remove('active');
                    db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
                    initApp();
                }
            } else {
                alert('L√ºtfen bir kullanƒ±cƒ± adƒ± girin.');
            }
        });

        modalUsernameCancel.addEventListener('click', async () => {
            let defaultName = 'Arkada≈ü';
            let counter = 1;
            while (await isUsernameTaken(defaultName)) {
                defaultName = 'Arkada≈ü' + counter;
                counter++;
            }
            currentUser = defaultName;
            localStorage.setItem('chat_username', currentUser);
            usernameModal.classList.remove('active');
            db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
            initApp();
        });

        function initApp() {
            currentUsernameSpan.textContent = currentUser;
            avatarLetter.textContent = currentUser.charAt(0).toUpperCase();
            applyTheme(currentTheme);

            if (currentUser === ADMIN_USER) {
                const badge = document.createElement('span');
                badge.className = 'admin-badge';
                badge.textContent = 'ADMIN';
                document.getElementById('user-footer').querySelector('div').appendChild(badge);
            }

            db.ref('servers/genel').once('value', (snap) => {
                if (!snap.exists()) {
                    db.ref('servers/genel').set({
                        name: 'genel',
                        channels: { genel: true, random: true, sohbet: true }
                    });
                }
            });

            db.ref('servers').on('value', (snap) => {
                renderServerList(snap.val() || {});
            });

            db.ref('users/' + currentUser + '/friends').on('value', (snap) => {
                renderFriendsList(snap.val() || {});
            });

            switchServer('genel');

            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                serverMenu.classList.remove('active');
            });
            document.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.style.backgroundColor = '#f0f0f0';
            } else {
                document.body.style.backgroundColor = '#1e2124';
            }
        }

        function renderServerList(serversData) {
            let html = '';
            for (let id in serversData) {
                const activeClass = (id === currentServer && !currentDMFriend) ? 'active' : '';
                html += `<div class="server-icon ${activeClass}" data-server-id="${id}" oncontextmenu="showServerContextMenu(event, '${id}')" onclick="switchServer('${id}')">${serversData[id].name.charAt(0).toUpperCase()}</div>`;
            }
            html += `<div class="server-divider"></div>`;
            html += `<div class="server-icon add-server" onclick="openServerModal()"><i class="fas fa-plus"></i></div>`;
            html += `<div class="server-icon dm ${!currentServer && currentDMFriend ? 'active' : ''}" onclick="openDMHome()"><i class="fas fa-comment"></i></div>`;
            document.getElementById('server-list').innerHTML = html;
        }

        function renderFriendsList(friendsData) {
            let friendsHtml = '';
            let dmHtml = '';
            for (let friend in friendsData) {
                friendsHtml += `<div class="user-item">
                    <div class="user-info" onclick="openDM('${friend}')">
                        <div class="user-status"></div>
                        <span class="user-name">${friend}</span>
                    </div>
                    <i class="fas fa-trash delete-friend" onclick="deleteFriend('${friend}')"></i>
                </div>`;
                dmHtml += `<div class="user-item" onclick="openDM('${friend}')">
                    <div class="user-info">
                        <div class="user-status"></div>
                        <span class="user-name">${friend}</span>
                    </div>
                </div>`;
            }
            document.getElementById('friends-list').innerHTML = friendsHtml;
            document.getElementById('dm-list').innerHTML = dmHtml;
        }

        function switchServer(serverId) {
            if (!serverId) return;
            currentServer = serverId;
            currentDMFriend = null;
            document.getElementById('current-server-name').style.display = 'flex';
            serverNameSpan.textContent = serverId;
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            const activeServerIcon = document.querySelector(`.server-icon[data-server-id="${serverId}"]`);
            if (activeServerIcon) activeServerIcon.classList.add('active');
            db.ref('servers/' + serverId + '/channels').once('value', (snap) => {
                const channels = snap.val() || {};
                let chHtml = '<div class="channel-category">METƒ∞N KANALLARI</div>';
                for (let ch in channels) {
                    const active = (ch === currentChannel) ? 'active' : '';
                    chHtml += `<div class="channel ${active}" onclick="switchChannel('${ch}')"><i class="fas fa-hashtag"></i>${ch}</div>`;
                }
                channelListDiv.innerHTML = chHtml;
                if (!channels[currentChannel]) {
                    const firstCh = Object.keys(channels)[0] || 'genel';
                    switchChannel(firstCh);
                } else {
                    loadMessages('server', currentServer + '_' + currentChannel);
                }
            });
        }

        function switchChannel(channel) {
            currentChannel = channel;
            currentDMFriend = null;
            document.querySelectorAll('.channel').forEach(ch => ch.classList.remove('active'));
            const activeChannel = Array.from(document.querySelectorAll('.channel')).find(el => el.textContent.trim() === channel);
            if (activeChannel) activeChannel.classList.add('active');
            currentChannelSpan.textContent = channel;
            chatHeaderIcon.className = 'fas fa-hashtag';
            loadMessages('server', currentServer + '_' + channel);
        }

        function openDM(friendUsername) {
            currentDMFriend = friendUsername;
            currentServer = null;
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            document.querySelector('.server-icon.dm').classList.add('active');
            document.getElementById('current-server-name').style.display = 'none';
            channelListDiv.innerHTML = '<div class="channel-category">DM</div><div class="channel active"><i class="fas fa-comment"></i> ' + friendUsername + '</div>';
            currentChannelSpan.textContent = friendUsername;
            chatHeaderIcon.className = 'fas fa-comment';
            const roomId = [currentUser, friendUsername].sort().join('_');
            loadMessages('dm', roomId);
        }

        function openDMHome() {
            currentDMFriend = null;
            currentServer = null;
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            document.querySelector('.server-icon.dm').classList.add('active');
            document.getElementById('current-server-name').style.display = 'none';
            channelListDiv.innerHTML = '<div class="channel-category">DOƒûRUDAN MESAJLAR</div><div class="channel"><i class="fas fa-info-circle"></i> Bir arkada≈ü se√ßin</div>';
            currentChannelSpan.textContent = 'Direkt Mesajlar';
            chatHeaderIcon.className = 'fas fa-comment';
            messagesContainer.innerHTML = '';
        }

        function loadMessages(type, id) {
            messagesContainer.innerHTML = '';
            let ref = (type === 'server') ? db.ref('messages/server/' + id) : db.ref('messages/dm/' + id);
            ref.off();
            ref.orderByChild('timestamp').on('child_added', (snap) => {
                const msg = snap.val();
                appendMessage(msg);
            });
        }

        function appendMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            if (msg.username === currentUser) {
                messageDiv.classList.add('own-message');
            }
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '';
            const avatarLetter = msg.username ? msg.username.charAt(0).toUpperCase() : '?';
            let contentHtml = '';
            if (msg.text) {
                contentHtml += `<div class="message-text">${escapeHtml(msg.text)}</div>`;
            }
            if (msg.imageBase64) {
                contentHtml += `<img src="${msg.imageBase64}" class="message-image" onclick="window.open(this.src)">`;
            }
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarLetter}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(msg.username)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${contentHtml}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function sendMessage(text, imageBase64 = null) {
            if (!text && !imageBase64) return;
            let ref;
            if (currentDMFriend) {
                const roomId = [currentUser, currentDMFriend].sort().join('_');
                ref = db.ref('messages/dm/' + roomId);
            } else {
                ref = db.ref('messages/server/' + currentServer + '_' + currentChannel);
            }
            const msg = {
                username: currentUser,
                text: text || '',
                timestamp: Date.now(),
            };
            if (imageBase64) msg.imageBase64 = imageBase64;
            ref.push(msg);
        }

        sendButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text);
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = messageInput.value.trim();
                if (text) {
                    sendMessage(text);
                    messageInput.value = '';
                }
            }
        });

        emojiButton.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPanel.classList.toggle('active');
        });

        document.querySelectorAll('.emoji-item').forEach(item => {
            item.addEventListener('click', () => {
                messageInput.value += item.textContent;
                messageInput.focus();
                emojiPanel.classList.remove('active');
            });
        });

        document.addEventListener('click', (e) => {
            if (!emojiPanel.contains(e.target) && e.target !== emojiButton) {
                emojiPanel.classList.remove('active');
            }
        });

        // Base64 resim y√ºkleme (Storage yerine)
        window.uploadImage = (input) => {
            if (isUploading) {
                alert('Zaten bir dosya y√ºkleniyor, l√ºtfen bekleyin.');
                return;
            }
            const file = input.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('L√ºtfen bir resim dosyasƒ± se√ßin.');
                fileInput.value = '';
                return;
            }

            if (file.size > 1 * 1024 * 1024) { // 1MB sƒ±nƒ±r (Realtime Database i√ßin)
                alert('Dosya boyutu 1MB\'dan b√ºy√ºk olamaz.');
                fileInput.value = '';
                return;
            }

            isUploading = true;
            attachButton.classList.add('loading');
            attachButton.style.opacity = '0.5';
            attachButton.title = 'Y√ºkleniyor...';

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result; // data:image/jpeg;base64,.....
                sendMessage('', base64);
                isUploading = false;
                attachButton.classList.remove('loading');
                attachButton.style.opacity = '';
                attachButton.title = 'Resim ekle';
                fileInput.value = '';
            };
            reader.onerror = (error) => {
                console.error('Okuma hatasƒ±:', error);
                alert('Resim okunamadƒ±.');
                isUploading = false;
                attachButton.classList.remove('loading');
                attachButton.style.opacity = '';
                attachButton.title = 'Resim ekle';
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        };

        window.openServerModal = () => {
            serverModal.classList.add('active');
        };
        window.closeServerModal = () => {
            serverModal.classList.remove('active');
            document.getElementById('new-server-name').value = '';
        };
        window.createServer = () => {
            const name = document.getElementById('new-server-name').value.trim();
            if (name) {
                db.ref('servers/' + name).set({
                    name: name,
                    channels: { genel: true, random: true, sohbet: true }
                });
                closeServerModal();
                switchServer(name);
            } else {
                alert('Sunucu adƒ± bo≈ü olamaz.');
            }
        };

        window.openFriendModal = () => {
            friendModal.classList.add('active');
        };
        window.closeFriendModal = () => {
            friendModal.classList.remove('active');
            document.getElementById('friend-username').value = '';
        };
        window.addFriend = () => {
            const friendName = document.getElementById('friend-username').value.trim();
            if (friendName && friendName !== currentUser) {
                db.ref('users/' + friendName).once('value', (snap) => {
                    if (snap.exists()) {
                        db.ref('users/' + currentUser + '/friends/' + friendName).set(Date.now());
                        db.ref('users/' + friendName + '/friends/' + currentUser).set(Date.now());
                        closeFriendModal();
                    } else {
                        alert('Bu kullanƒ±cƒ± bulunamadƒ±.');
                    }
                });
            } else {
                alert('Ge√ßerli bir kullanƒ±cƒ± adƒ± girin.');
            }
        };

        window.deleteFriend = (friendName) => {
            if (confirm(friendName + ' adlƒ± kullanƒ±cƒ±yƒ± arkada≈ülarƒ±ndan √ßƒ±karmak istediƒüine emin misin?')) {
                db.ref('users/' + currentUser + '/friends/' + friendName).remove();
                db.ref('users/' + friendName + '/friends/' + currentUser).remove();
                if (currentDMFriend === friendName) {
                    openDMHome();
                }
            }
        };

        window.showServerContextMenu = (event, serverId) => {
            event.preventDefault();
            selectedServerForDelete = serverId;
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
        };

        document.getElementById('delete-server-option').addEventListener('click', () => {
            if (selectedServerForDelete) {
                if (selectedServerForDelete === 'genel') {
                    alert('Ana sunucu silinemez.');
                } else if (confirm('"' + selectedServerForDelete + '" sunucusunu silmek istediƒüine emin misin?')) {
                    db.ref('servers/' + selectedServerForDelete).remove().then(() => {
                        if (currentServer === selectedServerForDelete) {
                            switchServer('genel');
                        }
                    });
                }
                contextMenu.style.display = 'none';
                selectedServerForDelete = null;
            }
        });

        serverMenuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            serverMenu.classList.toggle('active');
        });

        document.getElementById('delete-server-option-menu').addEventListener('click', () => {
            if (currentServer && currentServer !== 'genel') {
                if (confirm('"' + currentServer + '" sunucusunu silmek istediƒüine emin misin?')) {
                    db.ref('servers/' + currentServer).remove().then(() => {
                        switchServer('genel');
                    });
                }
            } else if (currentServer === 'genel') {
                alert('Ana sunucu silinemez.');
            }
            serverMenu.classList.remove('active');
        });

        document.getElementById('server-settings-option').addEventListener('click', () => {
            alert('Sunucu ayarlarƒ± hen√ºz eklenmedi.');
            serverMenu.classList.remove('active');
        });

        settingsButton.addEventListener('click', () => {
            settingsUsername.value = currentUser;
            settingsTheme.value = currentTheme;
            settingsModal.classList.add('active');
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        saveSettings.addEventListener('click', async () => {
            const newUsername = settingsUsername.value.trim();
            if (newUsername && newUsername !== currentUser) {
                const taken = await isUsernameTaken(newUsername);
                if (taken) {
                    alert('Bu kullanƒ±cƒ± adƒ± zaten alƒ±nmƒ±≈ü.');
                    return;
                }
                db.ref('users/' + currentUser).remove();
                currentUser = newUsername;
                localStorage.setItem('chat_username', currentUser);
                db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
                currentUsernameSpan.textContent = currentUser;
                avatarLetter.textContent = currentUser.charAt(0).toUpperCase();
            }
            const newTheme = settingsTheme.value;
            if (newTheme !== currentTheme) {
                currentTheme = newTheme;
                localStorage.setItem('theme', currentTheme);
                applyTheme(currentTheme);
            }
            settingsModal.classList.remove('active');
        });

        // Admin komutlarƒ±
        if (currentUser === ADMIN_USER) {
            console.log('%c‚úÖ Admin mod aktif!', 'color: gold; font-size: 16px;');
        }
    </script>
</body>
</html>