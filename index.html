<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sohbet ¬∑ Discord Benzeri</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; }
        body { height: 100vh; display: flex; background-color: #1e2124; overflow: hidden; }
        .servers { width: 72px; background-color: #1a1c1f; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; overflow-y: auto; }
        .server-icon { width: 48px; height: 48px; border-radius: 30px; background: #2b2f33; display: flex; align-items: center; justify-content: center; color: #d1d5da; font-size: 20px; font-weight: bold; transition: 0.1s; cursor: pointer; position: relative; }
        .server-icon.active { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-icon:hover { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-divider { width: 32px; height: 2px; background-color: #2b2f33; margin: 4px 0; }
        .server-icon.dm { background: #2f3136; color: #3ba55d; }
        .server-icon.add-server { background: #2f3136; color: #3a6ea5; font-size: 24px; }

        .channels-panel { width: 240px; background-color: #2b2f33; display: flex; flex-direction: column; color: #b9bbbe; }
        .server-name { padding: 18px 16px; font-weight: 600; color: #ffffff; border-bottom: 1px solid #1e2124; display: flex; align-items: center; justify-content: space-between; cursor: pointer; position: relative; }
        .channel-category { padding: 16px 16px 4px 16px; text-transform: uppercase; font-size: 12px; font-weight: 600; color: #8e9297; display: flex; align-items: center; justify-content: space-between; }
        .channel { padding: 6px 16px; margin: 1px 8px; border-radius: 6px; display: flex; align-items: center; gap: 8px; color: #b9bbbe; cursor: pointer; font-size: 15px; }
        .channel:hover { background-color: #35393f; color: #dcddde; }
        .channel.active { background-color: #3d434a; color: #ffffff; }
        .channel i { font-size: 20px; width: 22px; text-align: center; }
        .voice-channel { justify-content: space-between; }
        .user-count { background-color: #3d434a; border-radius: 10px; padding: 2px 6px; font-size: 12px; }

        .user-footer { padding: 16px; border-top: 1px solid #1e2124; display: flex; align-items: center; gap: 8px; margin-top: auto; }
        .chat-area { flex: 1; background-color: #31363b; display: flex; flex-direction: column; }
        .chat-header { padding: 12px 20px; background-color: #2f3338; border-bottom: 1px solid #1e2124; display: flex; align-items: center; gap: 10px; color: #ffffff; font-weight: 600; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .message { display: flex; gap: 16px; align-items: flex-start; }
        .message-avatar { width: 40px; height: 40px; border-radius: 20px; background-color: #3a6ea5; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-transform: uppercase; }
        .message-content { flex: 1; }
        .message-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
        .message-author { font-weight: 600; color: #ffffff; }
        .message-time { font-size: 11px; color: #8e9297; }
        .message-text { color: #d1d5da; word-wrap: break-word; background-color: #2f3338; padding: 8px 12px; border-radius: 18px; max-width: 70%; }
        .own-message .message-text { background-color: #3a6ea5; color: white; margin-left: auto; }
        .own-message { flex-direction: row-reverse; }
        .message-image { max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer; }

        .message-input-area { padding: 20px; background-color: #2f3338; border-top: 1px solid #1e2124; }
        .input-wrapper { background-color: #40464b; border-radius: 8px; padding: 0 16px; display: flex; align-items: center; }
        .input-wrapper input { flex: 1; background: transparent; border: none; padding: 12px 0; color: #dcddde; font-size: 15px; outline: none; }
        .input-wrapper i { color: #b9bbbe; font-size: 20px; margin-left: 12px; cursor: pointer; }

        .users-panel { width: 240px; background-color: #2b2f33; padding: 16px 8px; color: #b9bbbe; overflow-y: auto; }
        .users-title { text-transform: uppercase; font-size: 12px; font-weight: 600; padding: 0 8px 8px; border-bottom: 1px solid #1e2124; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .user-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; justify-content: space-between; }
        .user-item:hover { background-color: #35393f; }
        .user-status { width: 10px; height: 10px; border-radius: 50%; background-color: #3ba55d; }
        .user-name { font-size: 14px; color: #dcddde; }

        /* Ses kanalƒ± aray√ºz√º */
        .voice-controls { background-color: #2f3338; border-top: 1px solid #1e2124; padding: 10px; display: none; align-items: center; gap: 15px; }
        .voice-controls.active { display: flex; }
        .voice-controls i { font-size: 20px; color: #b9bbbe; cursor: pointer; }
        .voice-controls i:hover { color: white; }
        .voice-controls .leave-btn { color: #f04747; margin-left: auto; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: #2f3338; border-radius: 8px; width: 400px; padding: 20px; color: white; }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; background: #1e2124; border: 1px solid #3d434a; color: white; border-radius: 4px; margin-bottom: 16px; }
        .modal-content button { background: #3a6ea5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 8px; }
        .modal-content button.secondary { background: #3d434a; }

        #file-input { display: none; }
        .admin-badge { background-color: gold; color: black; border-radius: 4px; padding: 2px 6px; font-size: 10px; margin-left: 4px; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="servers" id="server-list"></div>
    <div class="channels-panel">
        <div class="server-name" id="current-server-name">
            <span id="server-name-text">genel</span>
        </div>
        <div id="channel-list"></div>
        <div class="user-footer">
            <div style="width:32px;height:32px;border-radius:16px;background:#3a6ea5;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;" id="avatar-letter">K</div>
            <div style="flex:1;color:white;font-size:14px;font-weight:500;" id="current-username">Y√ºkleniyor...</div>
            <i class="fas fa-cog" id="settings-button"></i>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <i class="fas fa-hashtag" id="channel-icon"></i>
            <span id="current-channel">genel</span>
        </div>
        <div class="messages-container" id="messages-container"></div>
        <div class="message-input-area">
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
                <i class="fas fa-paperclip" id="attach-button" onclick="document.getElementById('file-input').click()"></i>
                <i class="fas fa-smile" id="emoji-button"></i>
                <i class="fas fa-paper-plane" id="send-button"></i>
            </div>
        </div>
    </div>

    <div class="users-panel">
        <div class="users-title">Kullanƒ±cƒ±lar</div>
        <div id="users-list"></div>
    </div>

    <!-- Ses kontrol paneli -->
    <div class="voice-controls" id="voice-controls">
        <i class="fas fa-microphone" id="mute-mic"></i>
        <i class="fas fa-desktop" id="share-screen"></i>
        <span id="current-voice-channel" style="color:white; font-weight:500;"></span>
        <i class="fas fa-sign-out-alt leave-btn" id="leave-channel"></i>
    </div>

    <!-- Modallar -->
    <div class="modal active" id="username-modal">
        <div class="modal-content">
            <h2>Sesli Sohbet'e Ho≈ü Geldin</h2>
            <input type="text" id="modal-username" placeholder="Kullanƒ±cƒ± adƒ±">
            <button id="modal-username-save">Ba≈üla</button>
            <button class="secondary" id="modal-username-cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="server-modal">
        <div class="modal-content">
            <h2>‚ûï Yeni Sunucu</h2>
            <input type="text" id="new-server-name" placeholder="Sunucu adƒ±">
            <button onclick="createServer()">Olu≈ütur</button>
            <button class="secondary" onclick="closeServerModal()">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="voice-channel-modal">
        <div class="modal-content">
            <h2>‚ûï Ses Kanalƒ± Ekle</h2>
            <input type="text" id="new-voice-channel" placeholder="Kanal adƒ±">
            <button onclick="createVoiceChannel()">Olu≈ütur</button>
            <button class="secondary" onclick="closeVoiceModal()">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Ayarlar</h2>
            <input type="text" id="settings-username" placeholder="Yeni kullanƒ±cƒ± adƒ±">
            <select id="settings-theme">
                <option value="dark">Koyu</option>
                <option value="light">A√ßƒ±k</option>
            </select>
            <button id="save-settings">Kaydet</button>
            <button class="secondary" id="close-settings">Kapat</button>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*" onchange="uploadImage(this)">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCXca2LRaHFx6iZX9vhfe6lXMS9UY5nO54",
            authDomain: "rysu-server.firebaseapp.com",
            databaseURL: "https://rysu-server-default-rtdb.firebaseio.com",
            projectId: "rysu-server",
            storageBucket: "rysu-server.firebasestorage.app",
            messagingSenderId: "253844771451",
            appId: "1:253844771451:web:bd370ae5a93eae66fcc8de",
            measurementId: "G-T632DDDX6L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        let currentUser = localStorage.getItem('chat_username') || null;
        const ADMIN_USER = "AliUz60";
        let currentServer = 'genel';
        let currentChannel = 'genel';
        let currentVoiceChannel = null; // Aktif ses kanalƒ±
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let isUploading = false;

        // WebRTC deƒüi≈ükenleri
        let localStream = null;
        let peerConnections = {}; // Kullanƒ±cƒ± adƒ± -> RTCPeerConnection
        let screenStream = null;

        const usernameModal = document.getElementById('username-modal');
        const modalUsernameInput = document.getElementById('modal-username');
        const modalUsernameSave = document.getElementById('modal-username-save');
        const modalUsernameCancel = document.getElementById('modal-username-cancel');
        const serverModal = document.getElementById('server-modal');
        const voiceModal = document.getElementById('voice-channel-modal');
        const settingsModal = document.getElementById('settings-modal');
        const messagesContainer = document.getElementById('messages-container');
        const channelListDiv = document.getElementById('channel-list');
        const currentChannelSpan = document.getElementById('current-channel');
        const serverNameSpan = document.getElementById('server-name-text');
        const currentUsernameSpan = document.getElementById('current-username');
        const avatarLetter = document.getElementById('avatar-letter');
        const chatHeaderIcon = document.getElementById('channel-icon');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emojiButton = document.getElementById('emoji-button');
        const settingsButton = document.getElementById('settings-button');
        const saveSettings = document.getElementById('save-settings');
        const closeSettings = document.getElementById('close-settings');
        const settingsUsername = document.getElementById('settings-username');
        const settingsTheme = document.getElementById('settings-theme');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');
        const usersListDiv = document.getElementById('users-list');
        const voiceControls = document.getElementById('voice-controls');
        const currentVoiceSpan = document.getElementById('current-voice-channel');
        const muteMicBtn = document.getElementById('mute-mic');
        const shareScreenBtn = document.getElementById('share-screen');
        const leaveChannelBtn = document.getElementById('leave-channel');

        // Kullanƒ±cƒ± adƒ± benzersizlik kontrol√º
        async function isUsernameTaken(username) {
            const snap = await db.ref('users/' + username).once('value');
            return snap.exists();
        }

        if (currentUser) {
            usernameModal.classList.remove('active');
            initApp();
        } else {
            usernameModal.classList.add('active');
        }

        modalUsernameSave.addEventListener('click', async () => {
            const name = modalUsernameInput.value.trim();
            if (!name) { alert('ƒ∞sim girin'); return; }
            if (await isUsernameTaken(name)) {
                alert('Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü.');
                return;
            }
            currentUser = name;
            localStorage.setItem('chat_username', currentUser);
            usernameModal.classList.remove('active');
            db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
            initApp();
        });

        modalUsernameCancel.addEventListener('click', async () => {
            let defaultName = 'Kullanici';
            let counter = 1;
            while (await isUsernameTaken(defaultName)) defaultName = 'Kullanici' + counter++;
            currentUser = defaultName;
            localStorage.setItem('chat_username', currentUser);
            usernameModal.classList.remove('active');
            db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
            initApp();
        });

        function initApp() {
            currentUsernameSpan.textContent = currentUser;
            avatarLetter.textContent = currentUser.charAt(0).toUpperCase();
            applyTheme(currentTheme);

            if (currentUser === ADMIN_USER) {
                const badge = document.createElement('span');
                badge.className = 'admin-badge';
                badge.textContent = 'ADMIN';
                document.querySelector('.user-footer div').appendChild(badge);
            }

            db.ref('servers/genel').once('value', snap => {
                if (!snap.exists()) {
                    db.ref('servers/genel').set({
                        name: 'genel',
                        textChannels: { genel: true, random: true, sohbet: true },
                        voiceChannels: { 'Sohbet Odasƒ±': true, Oyun: true, M√ºzik: true }
                    });
                }
            });

            db.ref('servers').on('value', snap => renderServerList(snap.val() || {}));
            db.ref('users/' + currentUser + '/friends').on('value', snap => {}); // arkada≈ülƒ±k basit
            loadAllUsers();
            switchServer('genel');

            // Ses kanalƒ± katƒ±lƒ±mcƒ±larƒ±nƒ± dinle
            db.ref('voiceParticipants').on('value', snap => {
                if (currentVoiceChannel) {
                    const participants = snap.val() || {};
                    const inThisChannel = Object.entries(participants)
                        .filter(([_, data]) => data.channel === currentVoiceChannel && data.user !== currentUser)
                        .map(([user, _]) => user);
                    // Yeni katƒ±lanlarla baƒülantƒ± kur, ayrƒ±lanlarƒ± kaldƒ±r
                    handleParticipants(inThisChannel);
                }
            });
        }

        function loadAllUsers() {
            db.ref('users').on('value', snap => {
                let html = '';
                snap.forEach(child => {
                    const user = child.key;
                    if (user !== currentUser) {
                        html += `<div class="user-item"><span class="user-name">${user}</span></div>`;
                    }
                });
                usersListDiv.innerHTML = html;
            });
        }

        function renderServerList(servers) {
            let html = '';
            for (let id in servers) {
                html += `<div class="server-icon ${id === currentServer ? 'active' : ''}" onclick="switchServer('${id}')">${id.charAt(0).toUpperCase()}</div>`;
            }
            html += `<div class="server-divider"></div>`;
            html += `<div class="server-icon add-server" onclick="openServerModal()"><i class="fas fa-plus"></i></div>`;
            document.getElementById('server-list').innerHTML = html;
        }

        function switchServer(serverId) {
            currentServer = serverId;
            serverNameSpan.textContent = serverId;
            db.ref('servers/' + serverId).once('value', snap => {
                const data = snap.val() || {};
                const textCh = data.textChannels || { genel: true };
                const voiceCh = data.voiceChannels || { 'Sohbet Odasƒ±': true };
                let chHtml = '<div class="channel-category">METƒ∞N KANALLARI</div>';
                for (let ch in textCh) {
                    chHtml += `<div class="channel" onclick="switchChannel('${ch}')"><i class="fas fa-hashtag"></i>${ch}</div>`;
                }
                chHtml += '<div class="channel-category">SES KANALLARI <i class="fas fa-plus" onclick="openVoiceModal()" style="cursor:pointer;"></i></div>';
                for (let vc in voiceCh) {
                    chHtml += `<div class="channel voice-channel" onclick="joinVoiceChannel('${vc}')">
                        <i class="fas fa-volume-up"></i>${vc}
                        <span class="user-count" id="vc-${vc}">0</span>
                    </div>`;
                }
                channelListDiv.innerHTML = chHtml;
                switchChannel('genel');
            });
        }

        function switchChannel(channel) {
            currentChannel = channel;
            currentChannelSpan.textContent = channel;
            chatHeaderIcon.className = 'fas fa-hashtag';
            loadMessages('server', currentServer + '_' + channel);
        }

        function loadMessages(type, id) {
            messagesContainer.innerHTML = '';
            let ref = type === 'server' ? db.ref('messages/server/' + id) : db.ref('messages/dm/' + id);
            ref.off();
            ref.orderByChild('timestamp').on('child_added', snap => appendMessage(snap.val()));
        }

        function appendMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message' + (msg.username === currentUser ? ' own-message' : '');
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '';
            let content = msg.text ? `<div class="message-text">${escapeHtml(msg.text)}</div>` : '';
            if (msg.imageUrl) content += `<img src="${escapeHtml(msg.imageUrl)}" class="message-image" onclick="window.open(this.src)">`;
            div.innerHTML = `
                <div class="message-avatar">${msg.username.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-header"><span class="message-author">${escapeHtml(msg.username)}</span><span class="message-time">${time}</span></div>
                    ${content}
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

        sendButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) sendMessage(text);
            messageInput.value = '';
        });

        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendButton.click();
        });

        function sendMessage(text, imageUrl = null) {
            let ref;
            if (currentVoiceChannel) {
                // Ses kanalƒ±ndayken mesajƒ± genel sohbet olarak g√∂nderelim
                ref = db.ref('messages/server/' + currentServer + '_' + currentChannel);
            } else {
                ref = db.ref('messages/server/' + currentServer + '_' + currentChannel);
            }
            ref.push({ username: currentUser, text, timestamp: Date.now(), imageUrl });
        }

        emojiButton.addEventListener('click', e => {
            // Basit emoji paneli a√ßƒ±labilir, ≈üimdilik atlƒ±yorum
        });

        window.uploadImage = (input) => {
            if (isUploading) return alert('Zaten y√ºkleniyor.');
            const file = input.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) return alert('Resim se√ßin.');
            if (file.size > 5*1024*1024) return alert('Max 5MB.');

            isUploading = true;
            attachButton.classList.add('loading');
            const storageRef = storage.ref('images/' + Date.now() + '_' + file.name);
            storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
                sendMessage('', url);
                isUploading = false;
                attachButton.classList.remove('loading');
                fileInput.value = '';
            }).catch(err => {
                console.error(err);
                alert('Y√ºkleme hatasƒ±');
                isUploading = false;
                attachButton.classList.remove('loading');
            });
        };

        // --- Ses Kanallarƒ± ---
        async function joinVoiceChannel(channelName) {
            if (currentVoiceChannel === channelName) return;
            if (currentVoiceChannel) await leaveVoiceChannel();

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                currentVoiceChannel = channelName;
                currentVoiceSpan.textContent = channelName;
                voiceControls.classList.add('active');

                // Firebase'e katƒ±lƒ±m kaydƒ±
                await db.ref('voiceParticipants/' + currentUser).set({ channel: channelName, joined: Date.now() });

                // Diƒüer katƒ±lƒ±mcƒ±larƒ± bul ve baƒülan
                const participantsSnap = await db.ref('voiceParticipants').once('value');
                const participants = participantsSnap.val() || {};
                for (let [user, data] of Object.entries(participants)) {
                    if (user !== currentUser && data.channel === channelName) {
                        createPeerConnection(user, true); // arayan taraf
                    }
                }

                // Ses kanalƒ±ndaki ki≈üi sayƒ±sƒ±nƒ± g√ºncelle
                updateVoiceCounts();
            } catch (err) {
                console.error('Ses kanalƒ±na katƒ±lamadƒ±:', err);
                alert('Mikrofon eri≈üimi yok.');
            }
        }

        function createPeerConnection(targetUser, initiator = false) {
            if (peerConnections[targetUser]) return;
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnections[targetUser] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = (event) => {
                // Gelen sesi oynatmak i√ßin yeni bir audio elementi olu≈ütur
                const audio = document.createElement('audio');
                audio.srcObject = event.streams[0];
                audio.autoplay = true;
                audio.setAttribute('data-user', targetUser);
                document.body.appendChild(audio);
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref('candidates/' + targetUser + '/' + currentUser + '/' + Date.now()).set(event.candidate.toJSON());
                }
            };

            if (initiator) {
                pc.createOffer().then(offer => {
                    pc.setLocalDescription(offer);
                    db.ref('offers/' + targetUser + '/' + currentUser).set(offer.toJSON());
                });
            }

            // Kar≈üƒ± taraftan gelen adaylarƒ± dinle
            const candidateRef = db.ref('candidates/' + currentUser + '/' + targetUser);
            candidateRef.on('child_added', snap => {
                pc.addIceCandidate(new RTCIceCandidate(snap.val()));
            });
        }

        function handleParticipants(usersInChannel) {
            // Yeni gelenler i√ßin baƒülantƒ± kur (arayan olarak)
            for (let user of usersInChannel) {
                if (!peerConnections[user]) {
                    createPeerConnection(user, true);
                }
            }
            // Ayrƒ±lanlarƒ± kaldƒ±r
            for (let user in peerConnections) {
                if (!usersInChannel.includes(user)) {
                    peerConnections[user].close();
                    delete peerConnections[user];
                    // Ses elementini kaldƒ±r
                    const audioEl = document.querySelector(`audio[data-user="${user}"]`);
                    if (audioEl) audioEl.remove();
                }
            }
        }

        async function leaveVoiceChannel() {
            if (!currentVoiceChannel) return;
            // Baƒülantƒ±larƒ± kapat
            for (let pc of Object.values(peerConnections)) pc.close();
            peerConnections = {};
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
            }
            // Firebase'den kaydƒ± sil
            await db.ref('voiceParticipants/' + currentUser).remove();
            // Ses elementlerini kaldƒ±r
            document.querySelectorAll('audio[data-user]').forEach(el => el.remove());
            currentVoiceChannel = null;
            voiceControls.classList.remove('active');
            updateVoiceCounts();
        }

        function updateVoiceCounts() {
            db.ref('voiceParticipants').once('value', snap => {
                const parts = snap.val() || {};
                const counts = {};
                for (let [user, data] of Object.entries(parts)) {
                    counts[data.channel] = (counts[data.channel] || 0) + 1;
                }
                for (let ch in counts) {
                    const el = document.getElementById(`vc-${ch}`);
                    if (el) el.textContent = counts[ch];
                }
            });
        }

        muteMicBtn.addEventListener('click', () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    muteMicBtn.style.color = audioTrack.enabled ? '#b9bbbe' : '#f04747';
                }
            }
        });

        shareScreenBtn.addEventListener('click', async () => {
            if (!currentVoiceChannel) return;
            try {
                if (!screenStream) {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    // Ekran payla≈üƒ±mƒ±nƒ± t√ºm baƒülantƒ±lara ekle
                    for (let pc of Object.values(peerConnections)) {
                        screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));
                    }
                    shareScreenBtn.style.color = '#3ba55d';
                } else {
                    screenStream.getTracks().forEach(t => t.stop());
                    screenStream = null;
                    shareScreenBtn.style.color = '#b9bbbe';
                }
            } catch (err) {
                console.error('Ekran payla≈üƒ±m hatasƒ±:', err);
            }
        });

        leaveChannelBtn.addEventListener('click', leaveVoiceChannel);

        // --- Arayan taraf i√ßin offer dinleme ---
        db.ref('offers/' + currentUser).on('child_added', snap => {
            const caller = snap.key;
            const offer = snap.val();
            if (!peerConnections[caller]) {
                createPeerConnection(caller, false);
                setTimeout(() => {
                    const pc = peerConnections[caller];
                    pc.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
                        return pc.createAnswer();
                    }).then(answer => {
                        pc.setLocalDescription(answer);
                        db.ref('answers/' + caller + '/' + currentUser).set(answer.toJSON());
                    });
                }, 500);
            }
        });

        db.ref('answers/' + currentUser).on('child_added', snap => {
            const target = snap.key;
            const answer = snap.val();
            if (peerConnections[target]) {
                peerConnections[target].setRemoteDescription(new RTCSessionDescription(answer));
            }
        });

        // Modal i≈ülevleri
        window.openServerModal = () => serverModal.classList.add('active');
        window.closeServerModal = () => serverModal.classList.remove('active');
        window.createServer = () => {
            const name = document.getElementById('new-server-name').value.trim();
            if (name) {
                db.ref('servers/' + name).set({ name, textChannels: { genel: true }, voiceChannels: { 'Genel Ses': true } });
                closeServerModal();
                switchServer(name);
            }
        };
        window.openVoiceModal = () => voiceModal.classList.add('active');
        window.closeVoiceModal = () => voiceModal.classList.remove('active');
        window.createVoiceChannel = () => {
            const name = document.getElementById('new-voice-channel').value.trim();
            if (name && currentServer) {
                db.ref('servers/' + currentServer + '/voiceChannels/' + name).set(true);
                closeVoiceModal();
                switchServer(currentServer);
            }
        };

        settingsButton.addEventListener('click', () => {
            settingsUsername.value = currentUser;
            settingsTheme.value = currentTheme;
            settingsModal.classList.add('active');
        });

        closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));

        saveSettings.addEventListener('click', async () => {
            const newName = settingsUsername.value.trim();
            if (newName && newName !== currentUser) {
                if (await isUsernameTaken(newName)) { alert('Bu isim alƒ±nmƒ±≈ü'); return; }
                await db.ref('users/' + currentUser).remove();
                currentUser = newName;
                localStorage.setItem('chat_username', currentUser);
                await db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
                currentUsernameSpan.textContent = currentUser;
                avatarLetter.textContent = currentUser.charAt(0).toUpperCase();
            }
            const newTheme = settingsTheme.value;
            if (newTheme !== currentTheme) {
                currentTheme = newTheme;
                localStorage.setItem('theme', currentTheme);
                applyTheme(newTheme);
            }
            settingsModal.classList.remove('active');
        });

        function applyTheme(theme) {
            document.body.style.backgroundColor = theme === 'light' ? '#f0f0f0' : '#1e2124';
        }

        // Admin komutlarƒ±
        if (currentUser === ADMIN_USER) {
            window.admin = {
                silSunucu: (name) => db.ref('servers/' + name).remove(),
                silKullanici: (name) => db.ref('users/' + name).remove(),
                duyuru: (msg) => db.ref('messages/server/genel_genel').push({ username: 'SYSTEM', text: 'üîî ' + msg, timestamp: Date.now() })
            };
            console.log('Admin komutlarƒ± aktif');
        }
    </script>
</body>
</html>